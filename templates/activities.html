{% extends 'base.html' %}
{% load static %}

{% block title %} Activity List {% endblock %}

{% block css %}
body {
    margin: 0;
    //font-family: "SF UI Text",sans-serif;
    font-size: 0.675rem;
    font-weight: 400;
    line-height: 1.5;
    color: #8687a7;
    text-align: left;
    background-color: #f3f5f7;
}
body[data-layout=horizontal] .page-content {
    //margin-top: 55px;
    //padding: 0 5px 60px 5px;
}
body[data-layout=horizontal] .container-fluid, body[data-layout=horizontal] .navbar-header {
    max-width: 98%;
}
.container-fluid{
	font-size: 11px;
}
.container-fluid, .container-lg, .container-md, .container-sm, .container-xl {
    width: 100%;
    padding-right: 12px;
    padding-left: 12px;
    margin-right: auto;
    margin-left: auto;
}
.page-title-box .page-title {
    line-height: 30px;
}
.form-control{
	height: calc(1.1em + 0.9rem + 1px);
	padding: 0.27rem 0.75rem;
}
.form-group {
    margin-bottom: 0rem;
}
label {
    margin-bottom: 0rem;
}
.wizard .btn {
	 padding: 0.07rem 0.5rem;
	font-size: 10px;
    height: 20px;
}
.table td, .table th {
    padding: 0.20rem;
}

/*---------signup-step-------------*/

.activity-container{
	padding: 5px 0px;
}

.wizard .nav-tabs {
	border-bottom-color: transparent;
}

.wizard > div.wizard-inner {
    position: relative;
    margin-bottom: 25px;
    text-align: center;
}

.connecting-line {
    height: 2px;
    background: #e0e0e0;
    position: absolute;
    width: 75%;
    margin: 0 auto;
    left: 0;
    right: 0;
    top: 15px;
}
.wizard .nav-tabs > li.active > a, .wizard .nav-tabs > li.active > a:hover, .wizard .nav-tabs > li.active > a:focus {
    cursor: default;
}
span.round-tab {
    width: 30px;
    height: 30px;
    line-height: 30px;
    border-radius: 50%;
    background: #fff;
    position: absolute;
    border: 1px solid #ddd;
}
.wizard li.active span.round-tab {
    background: #0db02b;
    color: #fff;
    border-color: #0db02b;
}
.wizard .nav-tabs > li.active > a i{
	color: #0db02b;
}

.wizard .nav-tabs > li {
    width: 24.8%;
}
.wizard .nav-tabs > li a i{
	position: absolute;
    top: -15px;
    transform: translate(-50%, -50%);
}
.wizard .tab-pane {
    padding-top: 20px;
}

.pull-right{
    float: right;
}

@media (max-width: 767px){
	.wizard .nav-tabs > li a i{
		display: none;
	}
}

select{
	font-size:10px !important;
	padding: 0.07rem 0.75rem !important;
}
{% endblock %}

{% block link %}
<link href="{% static 'libs/bootstrap-datepicker/css/bootstrap-datepicker.min.css' %}" rel="stylesheet" type="text/css" />
{% endblock %}

{% block page_content %}
<div class="page-content">

	<!-- start page title -->
	<div class="row">
		<div class="col-12">
			<div class="page-title-box d-flex align-items-center justify-content-between">
				<p class="page-title mb-0 font-size-12"><b>{{activitydata.ticket}}>>{{activitydata.job_no}}>>DA {{activitydata.da}}>>{{step}}</b></p>
				<div class="page-title-right">
					<a class="" href="/view_activity?id={{ request.GET.id }}">View Activity</a>&nbsp;
					<a class="" href="/media_list?activity_id={{ request.GET.id }}">Media File</a>
				</div>
			</div>
		</div>
	</div>
	<!-- end page title -->

	{% for message in messages  %}            
      	<div class="alert alert-{{ message.tags }} alert-dismissible fade show" role="alert">
            <strong>Message : </strong> {{ message }}
            <button type="button" class="close" data-dismiss="alert" aria-label="Close">
              <span aria-hidden="true">&times;</span>
            </button>
        </div>
    {% endfor %}  
	  <div class="row">
		<div class="col-lg-12">
		
				<div class="card">
					<div class="card-body">
						<section class="activity-container">
							<div class="container12">
								<div class="row d-flex justify-content-center">
									<div class="col-md-12">
										<div class="wizard">
											<div class="wizard-inner">
												<div class="connecting-line"></div>
												<ul class="nav nav-tabs" role="tablist">
													<li role="presentation" class="{% if request.GET.step == '1' %}active{% else %}disabled{% endif %}">
														<a href="/activities?step=1&id={{request.GET.id}}" data-toggle="fielding" aria-controls="fielding" role="tab" aria-expanded="true"><span class="round-tab">1</span> <i>Fielding</i></a>
													</li>
													<li role="presentation" class="{% if request.GET.step == '2' %}active{% else %}disabled{% endif %}">
														<a href="/activities?step=2&id={{request.GET.id}}" data-toggle="planning" aria-controls="planning" role="tab" aria-expanded="true"><span class="round-tab">2</span> <i>Planning(design)</i></a>
													</li>
													<li role="presentation" class="{% if request.GET.step == '3' %}active{% else %}disabled{% endif %}">
														<a href="/activities?step=3&id={{request.GET.id}}" data-toggle="drafting" aria-controls="drafting" role="tab" aria-expanded="true"><span class="round-tab">3</span> <i>Drafting</i></a>
													</li>
													<li role="presentation" class="{% if request.GET.step == '10' %}active{% else %}disabled{% endif %}">
														<a href="/activities?step=10&id={{request.GET.id}}" data-toggle="invoicing" aria-controls="invoicing" role="tab" aria-expanded="true"><span class="round-tab">4</span> <i>Invoicing</i></a>
													</li>
												</ul>
											</div>
							
												<div class="tab-content" id="main_form">
													<div class="tab-pane active" role="tabpanel" id="fielding">
														<h6 class="text-left" style="border-bottom:1px solid; color:#0caadc;"></h6>
														
														<div class="row">
															<div class="col-md-3 col-sm-4">
																<div class="form-group">
																	<label>Job receive date : {{activitydata.rec_date|date:"m/d/Y"}}</label> 
																</div>
															</div>
															<div class="col-md-3 col-sm-4">
																<div class="form-group">
																	<label>ECD : {{activitydata.ecd|date:"m/d/Y"}}</label> 
																</div>
															</div>
															<div class="col-md-3 col-sm-4">
																<div class="form-group">
																	<label>Client : {{activitydata.client_id.name}}</label>  
																</div>
															</div>
															<div class="col-md-3 col-sm-4">
																<div class="form-group">
																	<label>LUs : {{activitydata.lus}}</label>
																</div>
															</div>
															<div class="col-md-3 col-sm-4">
																<div class="form-group">
																	<label>Wire Center : {{activitydata.wire_center}}</label>
																</div>
															</div>
															<div class="col-md-3 col-sm-4">
																<div class="form-group">
																	<label>Job Type : {{activitydata.job_type}}</label>
																</div>
															</div>
															<div class="col-md-3 col-sm-4">
																<div class="form-group">
																	<label>Fielder : {{activitydata.assign_fielder.fname}} {{activitydata.assign_fielder.lname}}</label>
																</div>
															</div>
															<div class="col-md-3 col-sm-4">
																<div class="form-group">
																	<label>Engineer 1 : {{activitydata.assign_int_eng.fname}} {{activitydata.assign_int_eng.lname}}</label>
																</div>
															</div>
															<div class="col-md-3 col-sm-4">
																<div class="form-group">
																	<label>Engineer 2 : {{activitydata.int_eng2.fname}} {{activitydata.int_eng2.lname}}</label>
																</div>
															</div>
															
														</div>
														
														<h6 class="text-left" style="border-bottom:1px solid; margin-top:10px; color:#0caadc;">{{step}} Subtask</h6>
														<form novalidate action="/activities" method="post" enctype="multipart/form-data">
															<input type="hidden" name="activity_id" value="{{activitydata.id}}">
															<input type="hidden" name="type" value="{{act_type}}">
															<input type="hidden" name="added_by" value="{{request.user.id}}">
														<div class="table-responsive">
															<table class="table table-bordered dt-responsive nowrap" style="border-collapse: collapse; border-spacing: 0; width: 100%;">
																<thead>
																	<tr>
																		<th width=15%>Subtask</th>
																		<th width=15%>Status</th>
																		<th width=15%>Start Date</th>
																		<th width=15%>Completed Date</th>
																		<th width=6%></th>
																		<th width=17%>Remark</th>
																		<th width=17%>Attachment</th>
																	</tr>
																</thead>
																<tbody>
																
																<tr>
																		<td>
																			<label>Fielding QC</label>
																			<input type="hidden" value="<?php echo $sub_id;?>" name="subtask">			
																		</td>
																		<td>
																			<select class="form-control" name="status" required>
																				<option value="">--Select--</option>
																				<option value="0">Pending</option>
																				<option value="1">Ongoing</option>
																				<option value="2">Completed</option>
																			</select>
																		</td>
																		<td>
																			<input class="form-control" value="" type="text" autocomplete="off" name="start_date" title="Start Date" readonly style="background-color:#e9e9e9;">
																		</td>
																		<td>
																			<input class="form-control" value="" type="text" autocomplete="off" name="complete_date" title="Complete Date" readonly style="background-color:#e9e9e9;">
																		</td>
																		<td>
																			<div class="text-center">
																				<button type="submit" class="btn btn-success waves-effect waves-light"><i class="fa fa-save"></i></button>
																			</div>
																		</td>
																		<td>
																			<div class="text-center">
																				<button type="button" class="btn btn-secondary waves-effect waves-light" data-toggle="modal" data-target="#remark_modal" disabled ><i class="far fa-comment-dots"></i></button>
																			</div>
																		</td>
																		<td>
																			<div class="text-center">
																				<button type="button" class="btn btn-secondary waves-effect waves-light"  data-toggle="modal" data-target="#attachment_modal" disabled ><i class="fas fa-paperclip"></i></button>
																			</div>
																		</td>
																	</tr>
																</tbody>
															</table>
														</div>
														</form>
														<div class="text-center" style="float:right;">
																				<button type="button" class="btn btn-success waves-effect waves-light" data-toggle="modal" data-target="#add_subtask_modal">Add Subtask &nbsp;<i class="fa fa-plus"></i></button>
																			</div>
													</div>
													
													<div class="clearfix"></div>
												</div>
										</div>
									</div>
								</div>
							</div>
						</section>
					</div>
				</div>
		</div>
	</div>
	<!-- end row -->
</div>
<!-- End Page-content -->

<div class="modal fade" id="remark_modal" tabindex="-1" role="dialog" aria-labelledby="remark_modal_Title" aria-hidden="true">
	<div class="modal-dialog modal-dialog-scrollable">
		<div class="modal-content">
			<div class="modal-header">
				<h5 class="modal-title mt-0" id="remark_modal_Title">{{task_name}} Remark</h5>
				<button type="button" class="close" data-dismiss="modal" aria-label="Close">
					<span aria-hidden="true">&times;</span>
				</button>
			</div>
			<form action="<?php echo site_url('activities/save_remark') ?>" method="post">
			<input type="hidden" name="r_activity_id" value="<?php echo $editdata['id']; ?>">
			<input type="hidden" name="r_type" value="<?php echo $act_type; ?>">
			<input type="hidden" name="r_subtask_id" value="<?php echo $edit_subtask['id']; ?>">
			<input type="hidden" name="r_added_by" value="<?php echo $login_sess['admin_user_id']?>">
			<div class="modal-body">
				<table class="table">
					<thead>
						<th>User</th>
						<th>Comment</th>
					</thead> 
					<tbody>
						<?php if(!empty($current_subtask_remarks)){
							foreach($current_subtask_remarks as $r_k=>$r_v){ 
								$added_name = user_info($r_v['added_by']);
							?>
								<tr>
									<td><?php echo $added_name['fname']." ".$added_name['lname']; ?><br><?php echo date('d-m-Y H:i:s',strtotime($r_v['added_date'])); ?></td>
									<td><?php echo $r_v['remark']; ?></td>
								</tr>
						<?php	
							}
						} ?>
					</tbody>
				</table>
				<textarea class="form-control" name="remark" rows=5 title="Remarks"><?php echo show_value('remark'); ?></textarea>
			</div>
			<div class="modal-footer">
				<button type="button" class="btn btn-secondary" data-dismiss="modal">Close</button>
				<button type="submit" class="btn btn-primary">Save changes</button>
			</div>
			</form>
		</div>
		<!-- /.modal-content -->
	</div>
	<!-- /.modal-dialog -->
</div>
<!-- /.modal -->

<div class="modal fade" id="comp_attachment_modal" tabindex="-1" role="dialog" aria-labelledby="attachment_modal_Title" aria-hidden="true">
	<div class="modal-dialog modal-dialog-scrollable">
		<div class="modal-content">
			<div class="modal-header">
				<h5 class="modal-title mt-0" id="attachment_modal_Title"><?php echo $task_name;?></h5>
				<button type="button" class="close" data-dismiss="modal" aria-label="Close">
					<span aria-hidden="true">&times;</span>
				</button>
			</div>
			
			<div class="modal-body">
				<table class="table">
					<thead>
						<th>User</th>
						<th>File</th>
					</thead>
					<tbody class="Attach_Body">
						
					</tbody>
				</table>
				
			</div>
			<div class="modal-footer">
				<button type="button" class="btn btn-secondary" data-dismiss="modal">Close</button>
				
			</div>
			
		</div>
		<!-- /.modal-content -->
	</div>
	<!-- /.modal-dialog -->
</div>
<!-- /.modal -->

<div class="modal fade" id="add_subtask_modal" tabindex="-1" role="dialog" aria-labelledby="attachment_modal_Title" aria-hidden="true">
	<div class="modal-dialog modal-dialog-scrollable">
		<div class="modal-content">
			<div class="modal-header">
				<h5 class="modal-title mt-0" id="subtask_modal_Title">Add Subtask</h5>
				<button type="button" class="close" data-dismiss="modal" aria-label="Close">
					<span aria-hidden="true">&times;</span>
				</button>
			</div>
			<form action="<?php echo site_url('activities') ?>" method="post">
			<input type="hidden" name="activity_id" value="<?php echo $_GET['id']; ?>">
			<input type="hidden" name="type" value="<?php echo $act_type; ?>">
			<input type="hidden" name="added_by" value="<?php echo $login_sess['admin_user_id']?>">
			<input type="hidden" name="status" value="0">
			<div class="modal-body">
				<table class="table">
					<thead>
						<th></th>
						<th>Task</th>
					</thead>
					<tbody> 
						<?php if(!empty($subtask_data)){
							foreach($subtask_data as $s_k=>$sub_v){ 
							
							?>
								<tr>
									<td><input type="radio" name="subtask" value="<?php echo $sub_v['id'];?>"></td>
									<td><?php 
										echo $sub_v['subtask'];
										 ?>
									</td>
								</tr>
						<?php	
							}
						} ?>
					</tbody>
				</table>
				
			</div> 
			<div class="modal-footer">
			<?php if(!empty($last_row) && $last_row['status']!=2){?>
			<?php if(!empty($last_row) && $last_row['status']!=2){?>
			<a href="javascript:void();" class="btn btn-primary Alert_Pending_Task">Save</a>
			<?php }else{ ?>
			<button type="submit" class="btn btn-primary">Save</button>
			<?php } ?>
				<button type="button" class="btn btn-secondary" data-dismiss="modal">Close</button>
				
			</div>
			</form>
		</div>
		<!-- /.modal-content -->
	</div>
	<!-- /.modal-dialog -->
</div>
<!-- /.modal -->

{% endblock %}

{% block script %}
<!-- Required datatable js -->
<script src="{% static 'libs/bootstrap-datepicker/js/bootstrap-datepicker.min.js' %}"></script>
<script>
	// ------------step-wizard-------------
	$(document).ready(function () {
		$('.nav-tabs > li a[title]').tooltip();
		
		//Wizard
		$('a[data-toggle="tab"]').on('shown.bs.tab', function (e) {
	
			var target = $(e.target);
		
			if (target.parent().hasClass('disabled')) {
				return false;
			}
		});
	
		$(".next-step").click(function (e) {
	
			var active = $('.wizard .nav-tabs li.active');
			active.next().removeClass('disabled');
			nextTab(active);
	
		});
		$(".prev-step").click(function (e) {
	
			var active = $('.wizard .nav-tabs li.active');
			prevTab(active);
	
		});
	});
	
	function nextTab(elem) {
		$(elem).next().find('a[data-toggle="tab"]').click();
	}
	function prevTab(elem) {
		$(elem).prev().find('a[data-toggle="tab"]').click();
	}
	
	
	$('.nav-tabs').on('click', 'li', function() {
		$('.nav-tabs li.active').removeClass('active');
		$(this).addClass('active');
	});
	
	$(".Attach").click(function(){
		var activity_id="<?php echo $_GET['id']; ?>";
		var task="<?php echo $act_type; ?>";
		var subtask = $(this).attr("data-subtask");
			 $.ajax({
				 url: "<?php echo site_url('activities/ajax_all_attach');?>",
				 type: "post",
				 data: "activity_id="+activity_id+"&task="+task+"&subtask="+subtask ,
				 success: function (response) {
					 console.log(response);
						  $(".Attach_Body").html(response);
				  },
				 error: function(jqXHR, textStatus, errorThrown) {
					//console.log(textStatus, errorThrown);
				 }
			  });
		
	});
	$(".Remark").click(function(){
		var activity_id="<?php echo $_GET['id']; ?>";
		var task="<?php echo $act_type; ?>";
		var subtask = $(this).attr("data-subtask");
			 $.ajax({
				 url: "<?php echo site_url('activities/ajax_all_remark');?>",
				 type: "post",
				 data: "activity_id="+activity_id+"&task="+task+"&subtask="+subtask ,
				 success: function (response) {
					 console.log(response);
						  $(".Remark_Body").html(response);
				  },
				 error: function(jqXHR, textStatus, errorThrown) {
					//console.log(textStatus, errorThrown);
				 }
			  });
	});
	</script>
	<script>
	$(".Alert_Pending_Task").click(function(){
		alert("Please complete previous task first!");
	});
	</script>
{% endblock %}